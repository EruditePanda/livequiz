$ ->
    authorization_key = $('[data-attribute="authorization_key"]').val()
    session_key = $('[data-attribute="session_key"]').val()
    client_channel = session_key+"-client"
    server_channel = session_key+"-server"
    chat_channel = session_key+"-chat"

    pubnub = PUBNUB(
      publish_key: '<%= ENV.fetch('PUBNUB_PUBLISH_KEY') %>',
      subscribe_key: '<%= ENV.fetch('PUBNUB_SUBSCRIBE_KEY') %>',
      auth_key: authorization_key,
      uuid: authorization_key,
    )

    pubnub.subscribe
        channel: server_channel,
        message: (message, env, ch, timer, magic_ch) ->
          console.log 'Message Received.' + '<br>' + 'Channel: ' + ch + '<br>' + 'Message: ' + JSON.stringify(message) + '<br>' + 'Raw Envelope: ' + JSON.stringify(env) + '<br>' + 'Magic Channel: ' + JSON.stringify(magic_ch)
        connect: pub
    
    pubnub.subscribe
        channel: chat_channel,
        message: (m, env, ch, timer, magic_ch) ->
          console.log(m)
        presence: (m, env, ch, timer, magic_ch) ->
          console.log(m)
        connect: pub

    pubnub.here_now
        channel : chat_channel,
        callback : (m) ->
            console.log(m)

    pub = ->
      console.log 'Subscribing..'
    
      